# 主从复制
## 配置
* 建立复制 <br>
配置文件中加入 slaveof {masterHost} {masterPort} <br>
查看复制相关状态命令：`info replication` <br>
* 断开复制 <br>
断开主节点复制关系：`slaveof no one`<br>
切主操作流程：<br>
1）断开与旧主节点复制关系<br>
2）与新主节点建立复制关系<br>
3）删除从节点当前所有数据<br>
4）对新主节点进行复制操作<br>
* 安全性 <br>
对于数据比较重要的节点，可以通过设置requirepass参数进行密码验证，客户端需要使用auth进行校验，从节点的masterauth参数与主节点保持一致。<br>
* 只读<br>
从节点使用slave-read-only=yes配置为只读模式<br>
* 传输延迟<br>
默认传输延迟关闭，可通过repl-disable-tcp-nodelay参数控制。关闭是实时发送数据给从节点。开启时，一般延迟40毫秒，节约宽带。<br>
## 原理
* 复制过程<br>
1）保存主节点信息<br>
2）主从建立socket连接<br>
3）发送ping命令<br>
4）权限认证<br>
5）同步数据集（2.8后使用psync）<br>
6）命令持续复制<br>
* 数据同步<br>
1）全部复制：一般用于初次复制场景，全量数据复制，数据量大，网络开销大<br>
2）部分复制：用于处理主从复制中因网络闪断等原因造成的数据丢失，补发缺失数据<br>
主从节点之间维护心跳（ping）和偏移量（master_repl_offset）检查机制，保证主从节点通信正常和数据一致。<br>
当主节点执行写操作时，不仅会将写命令发送给从节点，还会写入复制缓存积压区<br>
* 读写分离<br>
主节点负责写入，从节点负责读。当使用从节点用于读写分离时会存在数据延迟、过期数据、从节点可用性等问题，需要根据自身业务提前作出规避。<br>
